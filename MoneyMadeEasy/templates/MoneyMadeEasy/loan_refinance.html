{% extends "MoneyMadeEasy/layout.html" %}

<!-- JS section to (1) compute refinanced loan payments and (2) add loans to expenses list -->
{% block script %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {

            // (1) Compute refinanced loan payments
            document.getElementById('form_compute_loan').onsubmit = function() {

                // Obtain and parse form data
                var payment_display = document.getElementById("payment_display"); 
                var amount = document.getElementById("amount").value;
                var period = document.getElementById("period").value;
                var IR_old = document.getElementById("IR_old").value;
                var frequency = document.getElementById("frequency").value;
                var start = document.getElementById("start").value;
                var num_payments = document.getElementById("num_payments").value;
                var last_payment = document.getElementById("last_payment").value;
                var next_payment = document.getElementById("next_payment").value;
                var IR_new = document.getElementById("IR_new").value;

                // Error catching in case of invalid form inputs
                if (amount.trim() == "") {
                    alert("Error: You must indicate the original loan amount.");
                    return false;
                } else if (period.trim() == "") {
                    alert("Error: You must indicate the loan term/period.");
                    return false;
                } else if (IR_old.trim() == "") {
                    alert("Error: You must indicate the original interest rate.");
                    return false;
                } else if (frequency == "None") {
                    alert("Error: You must indicate the payment frequency.");
                    return false;
                } else if (start == "None") {
                    alert("Error: You must indicate when the first payment occurred.");
                    return false;
                } else if (num_payments.trim() == "") {
                    alert("Error: You must indicate the number of payments made so far.");
                    return false;
                } else if (last_payment == "None") {
                    alert("Error: You must indicate when the last payment occurred.");
                    return false;
                } else if (next_payment == "None") {
                    alert("Error: You must indicate when the next payment will occur.");
                    return false;
                } else if (IR_new.trim() == "") {
                    alert("Error: You must indicate the new interest rate.");
                    return false;
                }
                
                // Compute new loan payment & display on screen
                var payment_old = compute_loan_old(amount, IR_old, period, start, frequency);
                var loan_outstanding = compute_loan_outstanding(amount, payment_old, IR_old, frequency, start, num_payments, last_payment);
                var payment_new = compute_loan_new(loan_outstanding, IR_new, frequency, next_payment, period * frequency - num_payments)
                payment_display.innerHTML = `New Monthly Payment: $${payment_new}`;  

                // Update hidden form field (if user wants to add loan to expenses list)
                document.getElementById("loan_amount").value = `${payment}`;
                return false;
            };

             // (2) Prompt user for loan name before adding it to list of expenses
             document.getElementById("form_add_loan").onsubmit = function() {
                var loan_name = prompt("Please enter a name for this loan.", "<Type loan name here>");

                if (loan_name == null || loan_name.trim() == "" || loan_name == "<Type loan name here>") {
                    alert("You must enter a valid loan name.");
                    return false;
                } else {
                    document.getElementById("loan_name").value = `${loan_name}`;
                }
            };
        });

        // Computes the original loan payment amount
        function compute_loan_old(amount, int_rate, period, start, frequency) {
    
            // Compute periodic interest rate & number of repayments
            i = (int_rate / 100) / frequency;
            n = period * frequency;

            // Compute annuity & corresponding payment amount
            annuity_PV = ((1 - Math.pow((1 + i), -n)) / i);
              
            if (start == "deferred") {
                annuity_PV *= (1 + i);
            }

            payment = (amount / annuity_PV).toFixed(2);
            return payment;
        };

        // Computes the current outstanding loan balance (after `num_payments` payments)
        function compute_loan_outstanding(loan_original, payment, int_rate, frequency, start, num_payments, last_payment) {
            
            // Compute periodic interest rate & equivalent monthly interest rate
            i = (int_rate / 100) / frequency;
            i_monthly = Math.pow((1 + i), frequency / 12) - 1;

            // Compute present value of original loan amount
            loan_original *= Math.pow((1 + i), num_payments);
            loan_original *= Math.pow((1 + i_monthly), last_payment);
          
            // Compute present value of the loan repayments made so far
            annuity_PV = payment * (Math.pow((1 + i), num_payments) - 1) / i;
            annuity_PV *= Math.pow((1 + i_monthly), last_payment)

            if (start == "deferred") {
                loan_original *= (1 + i);
                annuity_PV *= (1 + i);
            }

            // Return outstanding loan balance
            return loan_original - annuity_PV;
        }

        // Compute new loan payment amount
        function compute_loan_new(amount, int_rate, frequency, next_payment, remaining_payments) {

            // Compute periodic int. rate, equivalent monthly int. rate, and # payments to go
            i = (int_rate / 100) / frequency;
            i_monthly = Math.pow((1 + i), frequency / 12) - 1;
            n = remaining_payments;

            // Compute outstanding loan balance one period before the first new payment commences
            scale_factor = Math.pow((1 + i_monthly), next_payment) * Math.pow((1 + i), -1);
            amount *= scale_factor;
            
            // Compute annuity, new payment amount, & return new amount
            annuity_PV = (1 - Math.pow((1 + i), -n)) / i;
            payment = (amount / annuity_PV).toFixed(2);
            return payment;
        };
    </script>
{% endblock %}

<!-- Form to refinance an existing loan w/ a new interest rate -->
{% block body %}
    <form id="form_compute_loan">
        <h3>Refinance an Existing Loan</h3>
        <ul>
            <li>
                Original Loan Amount ($): <input type="number" id="amount" placeholder="Original Loan Amount ($)" min="0.01" step="0.01">
            </li>
            <li>
                Loan Period (Yrs): <input type="number" id="period" placeholder="Loan Period (Yrs.)" min="1" step="1">
            </li>
            <li>
                Original Annual IR (%): <input type="number" id="IR_old" placeholder="Original Annual Interest Rate (%)" min="0.01" step="0.01">
            </li>
            <li>
                <label for="frequency">Payment Frequency: </label>
                <select id="frequency">
                    <option value="None">Select an option...</option>
                    <option value="12">Monthly</option>
                    <option value="6">Every Two Months</option>
                    <option value="4">Every Three Months</option>
                    <option value="2">Every Six Months</option>
                    <option value="1">Annually</option>
                </select>
            </li>
            <li>
                <label for="start">First Payment Was: </label>
                <select id="start">
                    <option value="None">Select an option...</option>
                    <option value="immediate">Immediate</option>
                    <option value="deferred">Deferred</option>
                </select>
            </li>
            <li>
                Number of Payments Made: <input type="number" id="num_payments" placeholder="Number of Payments Made" min="1" step="1">
            </li>
            <hr>
            <li>
                <label for="last_payment">Last Payment Was __ Month(s) Ago:</label>
                <select id="last_payment">
                    <option value="None">Select an option...</option>
                    <option value="0">0</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9</option>
                    <option value="10">10</option>
                    <option value="11">11</option>
                    <option value="12">12</option>
                </select>
            </li>
            <li>
                <label for="next_payment">Next Payment Due in __ Month(s):</label>
                <select id="next_payment">
                    <option value="None">Select an option...</option>
                    <option value="0">Due Immediate</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9</option>
                    <option value="10">10</option>
                    <option value="11">11</option>
                    <option value="12">12</option>
                </select>
            </li>
            <li>
                New Annual IR (%): <input type="number" id="IR_new" placeholder="New Annual Interest Rate (%)" min="0.01" step="0.01">
            </li>
        </ul>
        <input type="submit" value="Calculate New Payment">
    </form>
    <h4 id="payment_display">New Monthly Payment: $0.00</h4>

     <!-- Form to add this^^ loan to monthly expenses list -->
     <form id="form_add_loan" action="{% url 'add_expense' %}" method="POST">
        {% csrf_token %}
        <input type="hidden" name="user_ID" value="{{ request.user.id }}">
        <input type="hidden" name="name" id="loan_name" value="(INSERT LOAN NAME HERE)">
        <input type="hidden" name="category" value="Loan">
        <input type="hidden" name="amount" id="loan_amount" value="0.00">
        <input type="submit" value="Add to Monthly Expenses">
    </form>
    <br>
    <a href="{% url 'loan_new' %}">Calculate a New Loan?</a>
{% endblock %}